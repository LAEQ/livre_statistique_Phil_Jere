
# (PART) Analyses exploratoires multivariées {-}

# Méthodes factorielles {#chap09}

Les modèles multiniveaux sont simplement une extension des modèles à effets mixtes qui permettent de modéliser un phénomène avec une structure hiérarchique des données.

::: {.bloc_notes data-latex=""}

**Rappel de la structure hiérarchique des données**

**Exemple à deux niveaux :** il s’agit de modéliser un phénomène $y_{ij}$, soit une variable dépendante *Y* pour un individu *i* (niveau) niché dans un groupe *j* (niveau 2). Par exemple, modéliser l’indice de masse corporelle (IMC) de 5000 individus résidant dans 100 quartiers différents.

**Exemple à trois niveaux :** il s’agit de modéliser un phénomène $y_{ijk}$, soit une variable dépendante *Y* pour un individu *i* (niveau 1), niché dans un groupe *j* (niveau 2) appartenant à un groupe *k* (niveau 3). Par exemple, modéliser les notes à un examen de mathématiques d’élèves (niveau 1) nichés dans des classes (niveau 2) nichées dans des écoles (niveau 3).

:::

Nous avons largement décrits précédemment trois principaux types de modèles d’effets mixtes (GLMM) :

* les GLMM avec constantes aléatoires qui permettent d'avoir une constante différente pour chacun des groupes (niveau 2).
* les GLMM avec pentes aléatoires qui permettent de faire varier une variable indépendante au niveau 1 (coefficient) en fonction des groupes au niveau 2.
* les GLMM avec constantes et pentes aléatoires.

Les modèles multiniveau se différencient des modèles à effets mixtes puisqu'ils permettent d'introduire des variables indépendantes mesurées aux niveaux supérieurs (2 et 3).


## Les modèles multiniveaux : deux intérêts majeurs

### La répartition de la variance entre les différents niveaux

Les analyses multiniveaux permettent d’estimer comment se répartit la variance entre les différents niveaux du jeu de données. Dans les deux exemples de l'encadré précédent, ils permettraient de répondre aux questions suivantes :

* Quel niveau explique le plus l’IMC, le niveau individuel (niveau 1) ou le niveau contextuel (niveau 2)?
* Comment se répartit la variance des notes à l’examen de mathématiques entre les trois niveaux? A-t-on plus de variance pour les individus (niveau 1) ou au sein des classes (niveau 2) ou entre les différentes écoles (niveau 3)?

### L'estimation des coefficients aux différents niveaux
Les analyses multiniveau permettent d’estimer simultanément les coefficients de plusieurs variables indépendantes introduites à chacun des niveaux du modèle. Autrement dit, de voir comment les variables indépendantes introduites aux différents niveaux influencent la variable *Y* dépendante mesurée au niveau 1?

Si nous reprenons l'exemple à trois niveaux (élèves / classes / école), plusieurs facteurs peuvent influencer la réussite ou la performance scolaire des élèves aux différents niveaux :

* **Variables indépendantes au niveau 1** (élève) : âge, sexe, statut socioéconomique, langue maternelle autre que la langue d'enseignement...
* **Variables indépendantes au niveau 2** (classe) : nombre d’élèves par classe, programme spécialisée ou pas...
* **Variables indépendantes au niveau 3** (école) : indice de défavorisation de l’école, école publique ou privée, qualité des infrastructures de l'école (bâtiment, gymnase, cour d'école)...


Dans la même veine, afin d'illustrer l'apport des modèles multiniveau dans le champ de la géographie de la santé, Philibert et Apparicio  [-@philibert2007statistiques, p. 129] signalent que « pour un modèle à deux niveaux, il s’agit de modéliser $y_{ij}$, par exemple l’IMC d’un individu *i* (niveau 1) résidant dans un quartier *j* (niveau 2). Il est alors possible de mettre des variables explicatives tant au niveau 1 (âge, sexe, revenu, niveau d’éducation, etc.) qu’au niveau 2 (niveau de défavorisation sociale du quartier, offre de services et d’équipements sportifs et récréatifs, caractéristiques de l’environnement urbain, etc.). Dans cet exemple, on peut voir comment la modélisation multiniveaux permet d’estimer simultanément les effets environnementaux et individuels de manière à distinguer la contribution de chacun des niveaux (ex. : l’effet du revenu des individus et celui de la défavorisation du quartier) dans l’explication des variations géographiques observées ».

::: {.bloc_aller_loin data-latex=""}
**Évaluer les effets de milieu avec des analyses multiniveaux**

Dans les champs de la santé des populations et des études urbaines, les modèles multiniveaux sont largement mobilisés pour évaluer les effets de milieu (*neighbourhoods effects* ou *area effects* en anglais).

Atkinson et Kintrea [-@atkinson2001disentangling, p. 2278] définissent les « effets de milieu comme le changement net dans les potentialités de l’existence (*life chances*) attribuable au fait de vivre dans un quartier (ou une zone) plutôt qu'un autre  » (traduction libre). Les effets de milieu peuvent être positifs ou négatifs et peuvent concernant aussi bien les enfants que les adultes.

Les analyses multiniveaux sont particulièrement adaptées à l'évaluation des effets de milieu. En effet, plusieurs phénomènes – état de santé, comportement ou choix individuels – peuvent être en effet influencés à la fois par des caractéristiques individuelles (âge, sexe, niveau de revenu, niveau d'éducation, etc.) et par des caractéristiques contextuelles (caractéristiques du quartier).

Avec un modèle multiniveau, une fois contrôlées les caractéristiques individuelles (variables indépendantes mesurées au niveau 1), il est alors possible d'évaluer l'effet des caractéristiques du quartier (variables indépendantes mesurées au niveau 2) sur un phénomène $y_{ij}$ mesuré pour un individu *i* résidant dans un quartier *j*.
:::

## Les différents types de modèles multiniveaux

### Description du jeu de données utilisé 
Dans le cadre de cette section, nous présenterons uniquement les modèles à deux niveaux, soit pour modéliser un phénomène $y_{ij}$. Pour ce faire, nous utilisons des données tirées d'une étude de Pham et al. [-@apparicio2017disentangling]. Dans cet article, les auteurs souhaitent évaluer les effets des caractéristiques de la forme urbaine et des caractéristiques socioéconomiques sur la couverture des arbres de rues, et ce, à partir d'un modèle multiniveau. Ils disposent ainsi d'une structure hiérarchique des données avec deux niveaux : les tronçons de rues (niveau 1) inclus dans un et un seul secteur de recensement (niveau 2). La variable dépendante ($y_{ij}$) est le pourcentage du tronçon de rue couvert par des arbres, calculé à partir d'images satellites à haute résolution (Quickbird, 60 cm, septembre 2008). L'ensemble des variables utilisés pour les modèles sont reportées au tableau \@ref(tab:datamulti).

Sept variables indépendantes relatives à la forme urbaine sont mesurées au niveau des tronçons de rues tels que la largeur et la longueur de la rue, l'âge médian des bâtiments (introduit également au carré pour vérifier l'existence d'un effet curviliénaire; voir section \@ref(05511)), les pourcentages de bâtiments résidentiels, de duplex et de triplex, le nombre de bâtiments et finalement la distance moyenne entre le bâtiment et la rue. Les variables indépendantes au niveau des secteurs de recensement (niveau 2) sont extraites du recensement canadien de 2006 (tableau \@ref(tab:datamulti))


```{r datamulti, echo=FALSE, message=FALSE, warning=FALSE, out.width='75%'}
# chargement du jeu de données
load("data/multiniveau/dataArbres.RData")

vars <- c("PCTArb","Width","Length","AgeMed","ResiPCT","DuTriPct","NoLog","Setback",
          "ValLog","UDipPCT","PCTFRAVI","PCTIMGRE",
          "AvecEnf","FranPCT")

intitule <- c("Arbres (%)","Largeur des rues","Longueur de rues","Age médian des bâtiments",
              "Bâtiments résidentiels (%)","Duplex ou triplex (%)", "Nombre de bâtiments", "Distance entre le bâtiment et la rue",
              
              "Valeur moyenne des logements (milliers de $)","Diplômés universitaires (%)","Personnes à faible revenu (%)","Immigrants récents (%)",
              "Ménages avec enfants (%)","Langue marternelle française (%)")
type1 <- c("VD","VI","VI","VI","VI","VI","VI","VI","VI","VI","VI","VI","VI","VI")
type2 <- c("1","1","1","1","1","1","1","1","2","2","2","2","2","2")

moy <- round(sapply(Multiniveau[vars], mean),1)
et <- round(sapply(Multiniveau[vars], sd),1)

stats <- data.frame(cbind(moy, et))
stats <- cbind(vars, intitule, type1, type2, stats)

show_table(stats,
           digits = 1,
            caption = 'Statistiques descriptives pour les variables des modèles multiniveaux',
           col.names=c("Nom","Intitulé","Type", "Niveau", "Moy.", "E.-T."),
           align= c("l","l","c", "c", "r", "r")
           )

```

### Démarche classique pour les modèles multiniveaux

La démarche habituelle en analyses multiniveaux est de réaliser plusieurs modèles, allant du plus simple au plus complexe. Cette stratégie permet habituellement de mieux cerner la répartition de la variance entre les différents niveaux et l'apport des différentes variables explicatives introduites aux différents niveaux. De la sorte, cinq types de modèles peuvent réaliser :

1. le modèle vide (appelé aussi modèle inconditionnel) qui ne comprend aucune variables explicative et des constantes aléatoires au niveau 2.
2. le modèle avec uniquement les variables indépendantes au niveau 1 et des constantes aléatoires au niveau 2.
3. le modèle avec les variables indépendantes aux deux niveaux et des constantes aléatoires.
4. le modèle avec les variables indépendantes aux deux niveaux et des constantes et pentes aléatoires.
5. le modèle avec les variables indépendantes aux deux niveaux, incluant une interaction entre une variable indépendante mesurée au niveau 1 et autre mesuré au niveau 2.

Dans les sous-sections suivantes, nous détaillerons chacun de ces cinq modèles et prenant soin des montrer les similitudes qu'ils partagent avec les modèles à effets mixtes vus précédemment.

#### Le modèle vide



## Mise en œuvre dans R




Pour mettre en œuvre des modèles multiniveau avec une variable dépendante continue, on utilise la fonction `lmer` du *package* **lme4**. Pour d'autres distributions, on pourra utiliser la fonction `glmer` implémentant différentes familles de modèles GLM, notamment binomiale (modèle multiniveau logistique), gaussien, gamma, inverse gaussien, poisson, quasi-poisson, etc.

### Le modèle vide
Dans le code R ci-dessous, la syntaxe `lmer(PCTArb ~ 1 + (1| SRNOM),  data = Multiniveau)` permet de construire le modèle vide avec la variable indépendante `PCTArb` et `SRNOM` comme variable définissant les groupes au niveau 2, soit les 312 secteurs de recensement. À titre de rappel, le modèle vide ne comprend aucune variable indépendante.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
library("lme4")
library("performance")
library("MuMIn")
# chargement du jeu de données
load("data/multiniveau/dataArbres.RData")

# MODÈLE 1 : modèle vide (sans prédicteurs)
#------------------------------------------------------
# PCTArb : variable dépendante Yij soit 
# le pourcentage de la superficie du tronçon de rue i
# situé dans le secteur de recensement j
# couverte par la canopée des arbres
# SRNOM : code du niveau 2, soit le secteur de recensement

# Écrire Y ~ 1 signifie que le modèle est vide
# 1| SRNOM : signifie que l'on fait varier la constante avec la variable SRNOM

Modele1 <- lmer(PCTArb ~ 1 + (1| SRNOM),  data = Multiniveau)

# Nombre de groupes
cat("nombre de groupes =", length(unique(Multiniveau$SRNOM)))
```

La fonction `summary(Modele1)` permet d'afficher les résultats du modèle. Dans la section intitulée `Random effects`, la variance pour le niveau 2 (`SRNOM (Intercept)`) est de 19,82 contre 92,93 pour le niveau 1 (`Residual`). Le coefficient de corrélation intraclasse (ICC) est donc égal à $19,82 / (19,82+92,93) \times 100 = 17,58%$, ce qui signifie que près de 18% de la variance de la variable dépendante est imputable au niveau 2 (des secteurs de recensement) et 82% au niveau 1 (des tronçons).

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Résultats du modèle
summary(Modele1)
```

Notez qu'il est possible d'obtenir directement la valeur de l'ICC avec la fonction `icc(Modele1)` du *package* **performance** et les statistiques d'ajustement du modèle (avec les fonctions `logLik`, `AIC` et `BIC` du package **stats**).

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Calcul de l'ICC (coefficient intraclasse)
performance::icc(Modele1)
ICC1 <- performance::icc(Modele1)
cat("Part de la variance de la variable dépendante imputable au niveau 2 : ", 
    round(ICC1$ICC_adjusted*100,2), "%", sep="")

# Qualité d'ajustement du modèle
cat("Statistiques d'ajustement du modèle :",
    "\n-2 Log L = ", -2*logLik(Modele1),
    "\nAIC =", AIC(Modele1), 
    "\nBIC =", BIC(Modele1))
```

### Le modèle avec les variables indépendantes du niveau 1

Le second modèle consiste à introduire les variables indépendantes mesurées au niveau des tronçons de rues (niveau 1) et de faire varier la constante au niveau des secteurs de recensement (niveau 2). Vous aurez compris que ce modèle est tout simplement un modèle à effets mixtes avec des constantes aléatoires, tel décrit à la section \@ref(sect0721).

```{r, echo=TRUE, message=FALSE, warning=FALSE}

# MODÈLE 2 : modèle avec les prédicteurs au niveau 1 (rues) 
# ------------------------------------------------------
#   Width Length : Largeur et longueur de la rue
#   AgeMed AgeMed2 : Age médian des bâtiment
#   ResiPCT CommPCT InduPCT Parc01 : Occupations du sol
#   DupPCT TripPCT UniPCT : Types de bâtiments
#   Setback : Espacement entre le bâtiment et la rue
#   CBDkm : Distance au centre-ville

Modele2 <- lmer(PCTArb ~
                  # Variables indépendantes au niveau 1
                   Width+Length+AgeMed+AgeMed2+ResiPCT+CommPCT+InduPCT+Parc01+
                   DupPCT+TripPCT+UniPCT+Setback+CBDkm+
                   (1| SRNOM), data = Multiniveau)

# Résultats du modèle
summary(Modele2)
```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

VINiv1 <- c("Width","Length","AgeMed","AgeMed2","ResiPCT","CommPCT",
          "InduPCT","Parc01","DupPCT","TripPCT","UniPCT","Setback","CBDkm")
for (e in VINiv1){
  e.c <- paste(e, ".c", sep="")
  Multiniveau[[e.c]] <- Multiniveau[[e]] - mean(Multiniveau[[e]])
}

Modele2b <- lmer(PCTArb ~
                  # Variables indépendantes au niveau 1
                   Width.c+Length.c+AgeMed.c+AgeMed2.c+ResiPCT.c+
                   CommPCT.c+InduPCT.c+Parc01.c+
                   DupPCT.c+TripPCT.c+UniPCT.c+Setback.c+CBDkm.c+
                   (1| SRNOM), data = Multiniveau)

# Résultats du modèle
summary(Modele2b) 
```


À la lecture des résultats du modèle obtenus avec la syntaxe `summary(Modele2)`, les variables indépendantes du niveau les plus importantes sont : la longueur de la rue (`Length`), le pourcentage de bâtiments résidentiels (`ResiPCT`) et le pourcentage de logements unifamiliaux. Aussi, sans surprise, la distance entre le bâtiment et la rue (`Setback`) est associée positivement avec la variable dépendante.

Dans la section intitulée `Random effects`, la variance pour le niveau 2 est désormais de 14,23 contre 79,98 pour le niveau 1. Le coefficient de corrélation intraclasse (ICC) est donc égal à $14,23/(14,23+79,98) \times 100 = 15,1%$, ce qui signifie que près de 15% de la variance de la variable dépendante est imputable au niveau 2 (des secteurs de recensement), une fois contrôlées les caractéristiques des tronçons.

De nouveau, on peut directement obtenir le coefficient de corrélation intraclasse avec la fonction `icc` les R^2 marginal et conditionnel avec les fonctions `r.squaredGLMM(Modele2)` ou `r2_nakagawa`. À titre de rappel, le R^2^ marginal indique la proportion de la variance expliquée si uniquement les effets fixes avaient été pris en compte (ici 0,141). Quant au R^2^ conditionnel, il indique la proportion variance expliquée à la fois par les effets fixes et aléatoires (ici, 0,271). L'écart important entre les deux R^2 signale que les secteurs de recensements (effets aléatoire, niveau 2) jouent un rôle important dans le modèle.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Calcul de l'ICC (coefficient intra-classe)
performance::icc(Modele2)
ICC2 <- performance::icc(Modele2)
cat("Part de la variance de la variable dépendante ",
    "\nimputable au niveau 2 : ", round(ICC2$ICC_adjusted*100,2), "%", sep="")

# Calcul des R2 conditionnel et marginal avec les fonctions
# r.squaredGLMM ou r2_nakagawa du package performance
r.squaredGLMM(Modele2)
r2_nakagawa(Modele2)

# Qualité d'ajustement du modèle
cat("Statistiques d'ajustement du modèle",
    "\n-2 Log L = ", -2*logLik(Modele2),
    "\nAIC =", AIC(Modele2), 
    "\nBIC =", BIC(Modele2))
```


### Le modèle avec les variables indépendantes du niveau 1

Le troisième modèle comprend à la fois les variables indépendantes mesurées aux deux niveaux (tronçons et secteurs de recensement). Autrement, une fois contrôlées les caractéristiques du tronçon, on fait varier la constance au niveau 2 et on introduit les prédicteurs des secteurs du recensement.

```{r, echo=TRUE, message=FALSE, warning=FALSE}

# MODÈLE 3 : modèle avec les prédicteurs au niveau 1 et 2
# ------------------------------------------------------
#   Variables indépendantes au niveau 1
#     Width Length : Largeur et longueur de la rue
#     AgeMed AgeMed2 : Age médian des bâtiment
#     ResiPCT CommPCT InduPCT Parc01 : Occupations du sol
#     DupPCT TripPCT UniPCT : Types de bâtiments
#     Setback : Espacement entre le bâtiment et la rue
#     CBDkm : Distance au centre-ville
# 
#   Variables indépendantes au niveau 2
#     PCT_MV : Minorités visibles (%)
#     PCTFRAVI : Personnes à faible revenu (%)
#     P65PCT : 65 ans et plus (%)
#     LocaPCT : Locataires (%)
#     UDipPCT : Diplômés universitaires (%)
#     ValLog : Valeur du logement (milliers de $)

Modele3 <- lmer(PCTArb ~
                  # Variables indépendantes au niveau 1
                   Width+Length+AgeMed+AgeMed2+ResiPCT+CommPCT+InduPCT+Parc01+
                   DupPCT+TripPCT+UniPCT+Setback+CBDkm+
                  # Variables indépendantes au niveau 2
                  PCT_MV+PCTFRAVI+P65PCT+LocaPCT+UDipPCT+ValLog+
                  (1| SRNOM), data = Multiniveau)

# Résultats du modèle
summary(Modele3)

# Qualité d'ajustement du modèle
cat("\nStatistiques d'ajustement du modèle",
    "\n-2 Log L = ", -2*logLik(Modele3),
    "\nAIC =", AIC(Modele3), "\nBIC =", BIC(Modele3))

# Calcul de l'ICC (coefficient intra-classe)
performance::icc(Modele3)
ICC3 <- performance::icc(Modele3)
cat("\nPart de la variance de la variable dépendante ",
    "\nimputable au niveau 2 : ", round(ICC3$ICC_adjusted*100,2), "%", sep="")

# Calcul des R2 conditionnel et marginal avec les fonctions
# r.squaredGLMM ou r2_nakagawa du package performance
r.squaredGLMM(Modele2)
r2_nakagawa(Modele2)
```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
Modele3b <- lmer(PCTArb ~
                  # Variables indépendantes au niveau 1
                   Width.c+Length.c+AgeMed.c+AgeMed2.c+ResiPCT.c+CommPCT.c+
                   InduPCT.c+Parc01.c+
                   DupPCT.c+TripPCT.c+UniPCT.c+Setback.c+CBDkm.c+
                  # Variables indépendantes au niveau 2
                  PCT_MV+PCTFRAVI+P65PCT+LocaPCT+UDipPCT+ValLog+
                  (1| SRNOM), data = Multiniveau)
```

### Comparaison des trois modèles

Pour comparer les trois modèles, on utilise habituellement les statistiques d'ajustement du modèle vu plus haut, soit le -2 maximum de vraissemblance, l'AIC, l'ICC et les R^2^ marginal et conditionnel.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
c_logLik <- c(logLik(Modele1),logLik(Modele2),logLik(Modele3))
ICC <- c(performance::icc(Modele1)$ICC_adjusted,
         performance::icc(Modele2)$ICC_adjusted,
         performance::icc(Modele3)$ICC_adjusted)

R2m <- c(r.squaredGLMM(Modele1)[1],
         r.squaredGLMM(Modele2)[1],
         r.squaredGLMM(Modele3)[1])

R2c <- c(r.squaredGLMM(Modele1)[2],
         r.squaredGLMM(Modele2)[2],
         r.squaredGLMM(Modele3)[2])

print(data.frame(
            Modele = c("Modèle 1 (vide)", 
                       "Modèle 2 (VI : niv. 1)", 
                       "Modèle 3 (VI : niv. 1 et 2)"),
            dl = AIC(Modele1, Modele2, Modele3)$df,
            Moins2LogLik = round(-2*c_logLik,0),
            AIC = round(AIC(Modele1, Modele2, Modele3)$AIC,0),
            ICCpct = round(ICC*100,2),
            R2marg = round(R2m,3),
            R2cond = round(R2c,3)
))
```

Il est aussi de vérifier un modèle est significativement différent du modèle précédent avec la fonction `anova` qui compare les différences de leurs déviances. En guise d'exemple, la différence de déviance de 73 ($78544-78617=73$) entre les modèles 3 et 2 avec six degrés de liberté – puisque le modèle 3 inclus six variables indépendantes de plus que le précédent, $22-16=6$ – est significative (P<0,001). Cela signale que le modèle 3 est plus performant que le précédent.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
anova(Modele1, Modele2, Modele3)
```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
Modele4 <- lmer(PCTArb ~
                  # Variables indépendantes au niveau 1
                   Width+Length+AgeMed+AgeMed2+ResiPCT+CommPCT+InduPCT+Parc01+
                   DupPCT+TripPCT+UniPCT+Setback+CBDkm+
                  # Variables indépendantes au niveau 2
                  PCT_MV+PCTFRAVI+P65PCT+LocaPCT+UDipPCT+ValLog+
                  # Interaction entre une VI du niveau 1
                  # et un VI du niveau 3
                  ValLog*ResiPCT+
                  (1 | SRNOM), data = Multiniveau)
summary(Modele4)
```

## Un petit historique {#sect091}

## Analyses de composantes principales (ACP) {#sect092}

## Analyses factorielles de correspondances (AFC)  {#sect093}

## Analyses factorielles de correspondances multiples (AFM)  {#sect094}

## Analyses factorielles de correspondances mixte  {#sect095}
